name: Update V2Ray Subscriptions

on:
  push:
    paths:
      - 'main.txt'
      - 'subscriptions/**'
      - 'blocked_users.txt'
      - 'date_rules.txt'  # Add this line
  schedule:
    - cron: '0 0 * * *'  # Add daily check at midnight
  workflow_dispatch:
    inputs:
      blocked_users:
        description: 'Comma-separated usernames to block (e.g. john,mary,admin)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  update-subscriptions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Check Date-Based Blocking
        run: |
          python3 << 'EOF'
          import datetime
          import os
          
          # Read date rules
          try:
              with open('date_rules.txt', 'r') as f:
                  rules = f.readlines()
              print(f"Found {len(rules)} date rules")
          except FileNotFoundError:
              print("No date_rules.txt found")
              rules = []
          
          today = datetime.date.today()
          print(f"Today is: {today}")
          changes_made = False
          
          for rule in rules:
              rule = rule.strip()
              if not rule or rule.startswith('#'):
                  continue
              
              try:
                  filename, date_str = rule.split(' ', 1)
                  block_date = datetime.datetime.strptime(date_str, '%Y-%m-%d').date()
                  
                  print(f"Checking {filename}: block date {block_date}")
                  
                  if today >= block_date:
                      # Check if already blocked
                      blocked_content = ""
                      try:
                          with open('blocked_users.txt', 'r') as f:
                              blocked_content = f.read()
                      except FileNotFoundError:
                          pass
                      
                      if filename not in blocked_content:
                          with open('blocked_users.txt', 'a') as f:
                              f.write(f'{filename}\n')
                          print(f'✅ Auto-blocked {filename}')
                          changes_made = True
                      else:
                          print(f'⚠️ {filename} already blocked')
                  else:
                      days_left = (block_date - today).days
                      print(f'⏳ {filename} will be blocked in {days_left} days')
              except Exception as e:
                  print(f'❌ Error processing rule "{rule}": {e}')
          
          if changes_made:
              print("📝 Changes made to blocked_users.txt")
          else:
              print("✅ No date-based blocking needed")
          EOF
          
      - name: Create blocked_users.txt from manual input
        if: github.event.inputs.blocked_users != ''
        run: |
          echo "Creating blocked_users.txt from manual input"
          echo "${{ github.event.inputs.blocked_users }}" | tr ',' '\n' > blocked_users.txt
          
      - name: Update subscription files
        run: python scripts/update_subscriptions.py
        env:
          BLOCKED_USERS: ${{ secrets.BLOCKED_USERS }}
          
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update subscription files [$(date '+%Y-%m-%d %H:%M:%S')]"
            git push
          fi
