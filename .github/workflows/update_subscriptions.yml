name: Update V2Ray Subscriptions

on:
  push:
    paths:
      - 'main.txt'
      - 'subscriptions/**'
      - 'blocked_users.txt'
      - 'date_rules.txt'
  schedule:
    - cron: '*/5 * * * *'  # Check every 5 minutes for testing
  workflow_dispatch:
    inputs:
      blocked_users:
        description: 'Comma-separated usernames to block (e.g. john,mary,admin)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  update-subscriptions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Check Date-Time Based Blocking
        run: |
          python3 << 'EOF'
          import datetime
          
          # Set Iran timezone
          now = datetime.datetime.now()
          print(f"Current time: {now}")
          
          try:
              with open('date_rules.txt', 'r') as f:
                  rules = f.readlines()
              print(f"Found {len(rules)} date rules")
          except FileNotFoundError:
              print("No date_rules.txt found")
              rules = []
          
          changes_made = False
          
          for rule in rules:
              rule = rule.strip()
              if not rule or rule.startswith('#'):
                  continue
              
              try:
                  parts = rule.split(' ')
                  filename = parts[0]
                  date_str = parts[1]
                  time_str = parts[2] if len(parts) > 2 else "00:00"
                  
                  block_datetime = datetime.datetime.strptime(f"{date_str} {time_str}", '%Y-%m-%d %H:%M')
                  print(f"Checking {filename}: block time {block_datetime}")
                  
                  if now >= block_datetime:
                      blocked_content = ""
                      try:
                          with open('blocked_users.txt', 'r') as f:
                              blocked_content = f.read()
                      except FileNotFoundError:
                          pass
                      
                      if filename not in blocked_content:
                          with open('blocked_users.txt', 'a') as f:
                              f.write(f'{filename}\n')
                          print(f'âœ… Auto-blocked {filename} at {now}')
                          changes_made = True
                      else:
                          print(f'âš ï¸ {filename} already blocked')
                  else:
                      time_left = block_datetime - now
                      print(f'â³ {filename} will be blocked in {time_left}')
              except Exception as e:
                  print(f'âŒ Error processing rule "{rule}": {e}')
          
          if changes_made:
              print("ðŸ“ Changes made to blocked_users.txt")
          else:
              print("âœ… No time-based blocking needed")
          EOF
          
      - name: Create blocked_users.txt from manual input
        if: github.event.inputs.blocked_users != ''
        run: |
          echo "Creating blocked_users.txt from manual input"
          echo "${{ github.event.inputs.blocked_users }}" | tr ',' '\n' > blocked_users.txt
          
      - name: Update subscription files
        run: python scripts/update_subscriptions.py
        env:
          BLOCKED_USERS: ${{ secrets.BLOCKED_USERS }}
          
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update: c.txt blocked at $(date '+%Y-%m-%d %H:%M')"
            git push
          fi
